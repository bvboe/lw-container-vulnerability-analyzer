#!/bin/bash
cd "$(dirname "$0")"

DAYS_HISTORY=30

echo Analyze $DAYS_HISTORY days of history

mkdir -p data

for (( i=$DAYS_HISTORY; i>= 1; i--))
do
    DATE_STRING=`date -v-"$i"d +%Y-%m-%d`
    echo $DATE_STRING
    DATA_FILE_NAME="data/${DATE_STRING}-raw.json"
    if ! [ -f $DATA_FILE_NAME ]
    then
        echo Load scan data for $DATE_STRING
        lacework vulnerability container list-assessments --json --start "${DATE_STRING}T00:00:00.000Z" --end "${DATE_STRING}T23:59:59.999Z" > $DATA_FILE_NAME

        FILE_SIZE=$(wc -c <"$DATA_FILE_NAME")
        if [ $FILE_SIZE -lt 6 ]; then
            echo Null dataset returned, skipping
            rm $DATA_FILE_NAME
            continue
        fi
    else
        echo Skipping $DATE_STRING, already loaded
    fi

done
